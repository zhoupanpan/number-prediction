var u=(t,e,l)=>new Promise((a,r)=>{var i=n=>{try{d(l.next(n))}catch(y){r(y)}},o=n=>{try{d(l.throw(n))}catch(y){r(y)}},d=n=>n.done?a(n.value):Promise.resolve(n.value).then(i,o);d((l=l.apply(t,e)).next())});import{l as w}from"./utils-DS-Dv-fG.js";import{c,a as s,p as m,v as f,b,F as k,q as v,x as C,t as p,o as h,n as R,u as I,y as M}from"./vendor-DNlG_nFR.js";import{_ as x}from"./index-DdKafPJf.js";const g=w.createInstance({name:"number-prediction-db",storeName:"kill-code-maintenance"}),S={name:"KillCodeMaintenance",data(){return{records:[],searchTerm:"",editingId:null,batchRows:[],batchInputText:"",batchFormData:{period:""},currentPage:1,pageSize:10,selectedRecords:[],selectAll:!1}},computed:{filteredRecords(){let t=[...this.records];if(this.searchTerm){const l=this.searchTerm.toLowerCase();t=t.filter(a=>a.period.toLowerCase().includes(l)||a.killCode.toLowerCase().includes(l))}t.sort((l,a)=>a.period.localeCompare(l.period));const e=(this.currentPage-1)*this.pageSize;return t.slice(e,e+this.pageSize)},totalPages(){let t=[...this.records];if(this.searchTerm){const e=this.searchTerm.toLowerCase();t=t.filter(l=>l.period.toLowerCase().includes(e)||l.killCode.toLowerCase().includes(e))}return Math.ceil(t.length/this.pageSize)},canSaveBatch(){return this.batchFormData.period&&this.batchRows.length>0&&this.batchRows.every(t=>!t.isError&&t.killCode&&t.priority)}},watch:{filteredRecords(){this.selectedRecords=[],this.selectAll=!1}},mounted(){return u(this,null,function*(){yield this.loadRecords(),yield this.loadMaxPeriod();for(let t=0;t<3;t++)this.addBatchRow()})},methods:{loadRecords(){return u(this,null,function*(){try{this.records=[];const e=(yield g.keys()).map(l=>u(this,null,function*(){const a=yield g.getItem(l);a&&(a.createdAt||(a.createdAt=new Date(a.timestamp||Date.now()).toISOString()),this.records.push(a))}));yield Promise.all(e)}catch(t){console.error("加载记录失败:",t),alert("加载失败，请刷新页面重试")}})},loadMaxPeriod(){return u(this,null,function*(){try{const t=w.createInstance({name:"number-prediction-db",storeName:"period-management"}),e=yield t.keys(),l=[];for(const a of e){const r=yield t.getItem(a);r&&r.periodNumber&&l.push(r.periodNumber)}if(l.length>0){l.sort((r,i)=>i.localeCompare(r));const a=l[0];this.batchFormData.period=a,console.log("自动加载最大期号:",a)}else console.log("期号管理列表为空，无法加载最大期号")}catch(t){console.error("加载最大期号失败:",t)}})},getPriorityText(t){return{1:"最高",2:"高",3:"中",4:"低",5:"最低"}[t]||"未知"},formatDate(t){return new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})},toggleSelectAll(){this.selectAll?this.selectedRecords=this.filteredRecords.map(t=>t.id):this.selectedRecords=[]},deleteSelectedRecords(){return u(this,null,function*(){if(this.selectedRecords.length!==0&&confirm(`确定要删除选中的 ${this.selectedRecords.length} 条记录吗？`))try{const t=this.selectedRecords.map(e=>g.removeItem(e));yield Promise.all(t),this.records=this.records.filter(e=>!this.selectedRecords.includes(e.id)),this.selectedRecords=[],this.selectAll=!1,alert("批量删除成功")}catch(t){console.error("批量删除记录失败:",t),alert("批量删除失败，请重试")}})},addBatchRow(){this.batchRows.push({id:Date.now()+Math.random(),killCode:"",priority:"3",isError:!1,errorMessage:""})},removeBatchRow(t){this.batchRows.splice(t,1)},clearBatchRows(){this.batchRows=[]},processBatchInput(){if(!this.batchInputText.trim())return;const t=this.batchInputText.split(/[,，]/).map(l=>l.replace(/\s/g,"").trim()).filter(l=>l);if(t.length===0){alert("未找到有效的杀码组合数据");return}this.clearBatchRows();const e=Math.min(3,t.length);for(let l=0;l<e;l++){const a=t[l],r=/^\d{1,8}$/.test(a);this.batchRows.push({id:Date.now()+Math.random()+l,killCode:a,priority:"3",isError:!r,errorMessage:r?"":"杀码组合必须为1-8位纯数字"})}if(t.length>3)for(let l=3;l<t.length;l++){const a=t[l],r=/^\d{1,8}$/.test(a);this.batchRows.push({id:Date.now()+Math.random()+l,killCode:a,priority:"3",isError:!r,errorMessage:r?"":"杀码组合必须为1-8位纯数字"})}if(t.length<3){const l=3-t.length;for(let a=0;a<l;a++)this.batchRows.push({id:Date.now()+Math.random()+(t.length+a),killCode:"",priority:"3",isError:!1,errorMessage:""})}alert(`成功导入 ${t.length} 组杀码组合，已填充 ${this.batchRows.length} 行`),this.batchInputText=""},validateKillCodeInput(t){t.killCode=t.killCode.replace(/[^0-9]/g,""),/^\d{1,8}$/.test(t.killCode)?(t.isError=!1,t.errorMessage=""):(t.isError=!0,t.errorMessage="杀码组合必须为1-8位纯数字")},saveBatchRecords(){return u(this,null,function*(){try{const t=this.batchRows.filter(i=>!i.isError);if(t.length===0){alert("没有有效的杀码组合可以保存，请检查输入格式");return}const e=t.map(i=>u(this,null,function*(){const o={id:Date.now().toString()+Math.random().toString(36).substr(2,9),period:this.batchFormData.period,killCode:i.killCode,priority:parseInt(i.priority),createdAt:new Date().toISOString(),timestamp:Date.now()};return yield g.setItem(o.id,o),o})),l=yield Promise.all(e);this.records.push(...l),this.clearBatchRows(),this.batchFormData.period="";const a=this.batchRows.length-t.length;let r=`批量保存成功，共添加 ${l.length} 条有效记录`;a>0&&(r+=`，跳过 ${a} 条无效记录`),alert(r)}catch(t){console.error("批量保存失败:",t),alert("批量保存失败，请重试")}})},cancelEdit(){this.editingId=null,this.clearBatchRows(),this.batchFormData.period=""},editRecord(t){this.editingId=t.id,this.batchFormData.period=t.period,this.batchRows=[{id:t.id,killCode:t.killCode,priority:t.priority.toString(),isError:!1,errorMessage:""}]},deleteRecord(t){return u(this,null,function*(){if(confirm("确定要删除这条记录吗？"))try{yield g.removeItem(t),this.records=this.records.filter(e=>e.id!==t),alert("删除成功")}catch(e){console.error("删除失败:",e),alert("删除失败，请重试")}})}}},B={class:"kill-code-maintenance"},D={class:"batch-form-section"},P={class:"batch-controls"},_={class:"form-group"},E=["disabled"],T={class:"form-group"},V={class:"batch-actions"},A={class:"batch-table-container"},F={class:"batch-table"},U=["onUpdate:modelValue","onInput"],L={key:0,class:"error-message"},N=["onUpdate:modelValue"],z=["onClick"],q={key:0},K={class:"batch-actions"},O=["disabled"],j={class:"table-section"},G={class:"search-group"},H=["disabled"],J={class:"records-table-container"},Q={class:"data-table"},W={class:"checkbox-col"},X={class:"checkbox-col"},Y=["value"],Z={class:"action-buttons"},$=["onClick"],ee=["onClick"],te={key:0},se={key:0,class:"pagination"},oe=["disabled"],le={class:"page-info"},re=["disabled"];function ie(t,e,l,a,r,i){return h(),c("div",B,[e[26]||(e[26]=s("h2",null,"杀码组合维护",-1)),e[27]||(e[27]=s("p",null,"管理不同期号的杀码组合，设置优先级，用于排除预测中的数字组合",-1)),s("div",D,[s("div",P,[s("div",_,[e[14]||(e[14]=s("label",{for:"period"},"期号 *",-1)),m(s("input",{id:"period","onUpdate:modelValue":e[0]||(e[0]=o=>r.batchFormData.period=o),type:"text",placeholder:"请输入期号，如：2024001",disabled:r.editingId,required:""},null,8,E),[[f,r.batchFormData.period]])]),s("div",T,[e[15]||(e[15]=s("label",{for:"batchInput"},"批量输入杀码组合",-1)),m(s("input",{id:"batchInput","onUpdate:modelValue":e[1]||(e[1]=o=>r.batchInputText=o),type:"text",placeholder:"请输入多组杀码组合，用逗号分隔，如：0123,4567,89",onBlur:e[2]||(e[2]=(...o)=>i.processBatchInput&&i.processBatchInput(...o))},null,544),[[f,r.batchInputText]])]),s("div",V,[s("button",{type:"button",class:"btn-primary",onClick:e[3]||(e[3]=(...o)=>i.addBatchRow&&i.addBatchRow(...o))},"添加行"),s("button",{type:"button",class:"btn-secondary",onClick:e[4]||(e[4]=(...o)=>i.clearBatchRows&&i.clearBatchRows(...o))},"清空")])]),s("div",A,[s("table",F,[e[18]||(e[18]=s("thead",null,[s("tr",null,[s("th",null,"序号"),s("th",null,"杀码组合 *"),s("th",null,"优先级 *"),s("th",null,"操作")])],-1)),s("tbody",null,[(h(!0),c(k,null,v(r.batchRows,(o,d)=>(h(),c("tr",{key:o.id,class:R({"error-row":o.isError})},[s("td",null,p(d+1),1),s("td",null,[m(s("input",{"onUpdate:modelValue":n=>o.killCode=n,type:"text",placeholder:"请输入2位及以上数字，如：0123",onInput:n=>i.validateKillCodeInput(o),class:R({"error-input":o.isError}),required:""},null,42,U),[[f,o.killCode]]),o.isError?(h(),c("div",L,p(o.errorMessage),1)):b("",!0)]),s("td",null,[m(s("select",{"onUpdate:modelValue":n=>o.priority=n,required:""},[...e[16]||(e[16]=[M('<option value="1" data-v-f804feca>1 - 最高</option><option value="2" data-v-f804feca>2 - 高</option><option value="3" data-v-f804feca>3 - 中</option><option value="4" data-v-f804feca>4 - 低</option><option value="5" data-v-f804feca>5 - 最低</option>',5)])],8,N),[[I,o.priority]])]),s("td",null,[r.batchRows.length>1?(h(),c("button",{key:0,type:"button",class:"btn-delete",onClick:n=>i.removeBatchRow(d)},"删除",8,z)):b("",!0)])],2))),128))]),r.batchRows.length===0?(h(),c("tfoot",q,[...e[17]||(e[17]=[s("tr",null,[s("td",{colspan:"4",class:"no-data"},'请点击"添加行"开始录入杀码组合数据')],-1)])])):b("",!0)])]),s("div",K,[s("button",{type:"button",class:"btn-primary",onClick:e[5]||(e[5]=(...o)=>i.saveBatchRecords&&i.saveBatchRecords(...o)),disabled:!i.canSaveBatch},"批量保存",8,O),s("button",{type:"button",class:"btn-secondary",onClick:e[6]||(e[6]=(...o)=>i.cancelEdit&&i.cancelEdit(...o))},"取消")])]),s("div",j,[e[25]||(e[25]=s("h3",null,"杀码组合列表",-1)),s("div",G,[m(s("input",{"onUpdate:modelValue":e[7]||(e[7]=o=>r.searchTerm=o),type:"text",placeholder:"搜索期号或杀码组合...",class:"search-input"},null,512),[[f,r.searchTerm]]),s("button",{onClick:e[8]||(e[8]=(...o)=>i.deleteSelectedRecords&&i.deleteSelectedRecords(...o)),class:"btn-delete-batch",disabled:r.selectedRecords.length===0}," 批量删除 ",8,H)]),s("div",J,[s("table",Q,[s("thead",null,[s("tr",null,[s("th",W,[m(s("input",{type:"checkbox","onUpdate:modelValue":e[9]||(e[9]=o=>r.selectAll=o),onChange:e[10]||(e[10]=(...o)=>i.toggleSelectAll&&i.toggleSelectAll(...o))},null,544),[[C,r.selectAll]])]),e[19]||(e[19]=s("th",null,"期号",-1)),e[20]||(e[20]=s("th",null,"杀码组合",-1)),e[21]||(e[21]=s("th",null,"优先级",-1)),e[22]||(e[22]=s("th",null,"创建时间",-1)),e[23]||(e[23]=s("th",null,"操作",-1))])]),s("tbody",null,[(h(!0),c(k,null,v(i.filteredRecords,o=>(h(),c("tr",{key:o.id},[s("td",X,[m(s("input",{type:"checkbox","onUpdate:modelValue":e[11]||(e[11]=d=>r.selectedRecords=d),value:o.id},null,8,Y),[[C,r.selectedRecords]])]),s("td",null,p(o.period),1),s("td",null,p(o.killCode),1),s("td",null,[s("span",{class:R(["priority-badge",`priority-${o.priority}`])},p(i.getPriorityText(o.priority)),3)]),s("td",null,p(i.formatDate(o.createdAt)),1),s("td",Z,[s("button",{class:"btn-edit",onClick:d=>i.editRecord(o)},"编辑",8,$),s("button",{class:"btn-delete",onClick:d=>i.deleteRecord(o.id)},"删除",8,ee)])]))),128))]),i.filteredRecords.length===0?(h(),c("tfoot",te,[...e[24]||(e[24]=[s("tr",null,[s("td",{colspan:"6",class:"no-data"},"暂无数据")],-1)])])):b("",!0)])]),i.totalPages>1?(h(),c("div",se,[s("button",{onClick:e[12]||(e[12]=o=>r.currentPage--),disabled:r.currentPage===1,class:"btn-pagination"}," 上一页 ",8,oe),s("span",le," 第 "+p(r.currentPage)+" / "+p(i.totalPages)+" 页 ",1),s("button",{onClick:e[13]||(e[13]=o=>r.currentPage++),disabled:r.currentPage===i.totalPages,class:"btn-pagination"}," 下一页 ",8,re)])):b("",!0)])])}const he=x(S,[["render",ie],["__scopeId","data-v-f804feca"]]);export{he as default};
